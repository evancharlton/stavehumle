import{r as l,j as a,L}from"./index-BBXoJzDt.js";import{R as h,f as g,a as p}from"./firebase-import-BUDYfVK1.js";import{u as y,a as w}from"./useLogin-Dx810x-r.js";import{g as $,u as I,a as j,b as x,c as W,d as v,F as E,e as F}from"./useFoundWords-qo4Idc7-.js";import{f as T}from"./useFoundWords-qo4Idc7-.js";import{u as b}from"./useLang-DtiibKzr.js";const S=n=>fetch(n.replace(/^\/\//,"/"),{headers:{"Content-Type":"application/json"}}).then(e=>e.json()),k=()=>{const n=b(),{gameHash:e}=y(),[t,o]=l.useState(),r=h($);return l.useEffect(()=>{S(`//words/${n}/options.json`).then(s=>s[e%s.length]).then(s=>{const d=s.split(""),c=d[e%d.length],i=d.filter(u=>u!==c);return[c,...i.sort()].join("")}).then(s=>r(s)).catch(s=>{console.error(s),o(s)})},[e,n,r]),{error:t}},_=()=>{const n=b(),{all:e,centerLetter:t}=I(),o=h(j),[r,s]=l.useState();return l.useEffect(()=>{if(!e)return;const d=new Set(e.split(""));return S(`//words/${n}/words.json`).then(c=>c.filter(i=>{let u=!1;for(let f=0;f<i.length;f+=1){if(!d.has(i[f]))return!1;u=u||i[f]===t}return u})).then(c=>{o(c)}).catch(s),()=>{o([])}},[e,t,n,o]),{error:r}},z=({children:n,node:e})=>{const t=l.useCallback(({word:o,when:r,source:s})=>{s==="local"&&g.database().ref(e).update({[o]:r})},[e]);return x(t),a.jsx(a.Fragment,{children:n})},O=({children:n,node:e})=>{const t=p(W),{words:o}=v(),r=l.useCallback(s=>{const d=s.key;if(!d){console.warn("No key specified");return}if(t[d])return;const c=s.val();if(!o.includes(d)){console.warn(`"${d}" is not a recognized word`);return}const i=Date.parse(c);if(i===void 0){console.warn(`"${d}" didn't have a valid date (${c})`);return}window.dispatchEvent(new E(d,new Date(i),"remote"))},[o,t]);return l.useEffect(()=>{const s=g.database().ref(e);return s.on("child_added",r),()=>{s.off("child_added",r)}},[r,e]),a.jsx(a.Fragment,{children:n})},m=n=>{try{const e=localStorage.getItem(n);if(e){const t=JSON.parse(e);if(Array.isArray(t)){localStorage.setItem(`backup/${n}`,e);const o=t.filter(r=>typeof r=="string").reduce((r,s,d)=>({...r,[s]:new Date(d)}),{});return localStorage.setItem(n,JSON.stringify(o)),m(n)}return Object.entries(t).filter(([o,r])=>!!r).reduce((o,[r,s])=>({...o,[r]:s}),{})}}catch{}return{}},N=({children:n})=>{const{path:e}=w();return l.useEffect(()=>{const t={};for(let o=0;o<localStorage.length;o+=1){const r=localStorage.key(o);if(r&&!r.startsWith("backup")){if(r.includes("/saved/")){const s=m(r);if(Object.keys(s).length===0)continue;t[r]=s}r.includes("/revealed/")&&(t[r]=localStorage.getItem(r))}}Object.keys(t).length!==0&&g.database().ref(e).update(t)},[e]),a.jsx(a.Fragment,{children:n})},D=({children:n,node:e})=>{const{words:t}=v();return l.useEffect(()=>{g.database().ref(e).once("value").then(o=>{if(!o.exists())return;const r=t.reduce((c,i)=>({...c,[i]:!0}),{}),s={},d=o.val();Object.entries(d).forEach(([c,i])=>{if(!r[c]){console.warn(`"${c}" is not a recognized word`);return}const u=Date.parse(i);if(u===void 0){console.warn(`"${c}" as an invalid date (${i})`);return}s[c]=new Date(u)}),Object.entries(s).sort(([c,i],[u,f])=>+i-+f).forEach(([c,i])=>{window.dispatchEvent(new E(c,i,"remote"))})})},[e,t]),a.jsx(a.Fragment,{children:n})},R=({children:n})=>{const e=F(),{userId:t}=w();if(!t)return a.jsx(a.Fragment,{children:n});const o=`/users/${t}/${e}`;return a.jsx(N,{node:o,children:a.jsx(z,{node:o,children:a.jsx(D,{node:o,children:a.jsx(O,{node:o,children:a.jsx(a.Fragment,{children:n})})})})})},C=({children:n})=>{const e=F(),t=h(W);l.useEffect(()=>{t(m(e))},[e,t]);const o=l.useCallback(({word:r,when:s})=>{t(d=>{const c={...d,[r]:s};return localStorage.setItem(e,JSON.stringify(c)),c})},[e,t]);return x(o),a.jsx(a.Fragment,{children:n})},B=({children:n})=>{const{error:e}=k(),{error:t}=_();return p(j).length?e?a.jsx("div",{children:"Error loading the letters"}):t?(console.error(t),a.jsx("div",{children:"Error loading the words"})):a.jsx(C,{children:a.jsx(R,{children:n})}):a.jsx(L,{})};export{B as default,T as useFoundWords,I as useLetters,v as useWords};
