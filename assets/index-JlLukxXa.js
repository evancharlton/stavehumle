import{r as u,j as a,d as z}from"./index-CXYANt7Y.js";import{b as h,c as k,u as O,d as j,e as f,f as m,a as _,g as $}from"./useLogin-CnqRrNSo.js";import{u as x}from"./useLang-BNnM_o1C.js";const b=r=>fetch(r.replace(/^\/\//,"/"),{headers:{"Content-Type":"application/json"}}).then(e=>e.json()),w=h({key:"game/puzzleId",default:""}),R=k({key:"game/letters",get:({get:r})=>{const e=r(w),[t,...n]=e.split("");return{centerLetter:t,outerLetters:n,all:e.split("").sort().join("")}}}),W=h({key:"game/words",default:[]}),y=h({key:"game/words/found",default:{}}),N=h({key:"game/reveals",default:[]}),D=()=>{const r=x(),{gameHash:e}=O(),[t,n]=u.useState(),s=j(w);return u.useEffect(()=>{b(`//words/${r}/options.json`).then(o=>o[e%o.length]).then(o=>{const d=o.split(""),c=d[e%d.length],l=d.filter(i=>i!==c);return[c,...l.sort()].join("")}).then(o=>s(o)).catch(o=>{console.error(o),n(o)})},[e,r,s]),{error:t}},L=()=>{const r=f(w);return{...f(R),puzzleId:r}},C=()=>{const r=x(),{all:e,centerLetter:t}=L(),n=j(W),[s,o]=u.useState();return u.useEffect(()=>{if(!e)return;const d=new Set(e.split(""));return b(`//words/${r}/words.json`).then(c=>c.filter(l=>{let i=!1;for(let g=0;g<l.length;g+=1){if(!d.has(l[g]))return!1;i=i||l[g]===t}return i})).then(c=>{n(c)}).catch(o),()=>{n([])}},[e,t,r,n]),{error:s}},S=(r="saved")=>{const e=x(),t=f(w);return["stavehumle",e,r,t].join("/")},v="found-word";class F extends CustomEvent{constructor(e,t,n){super(v,{detail:{word:e,when:t,source:n}})}}const I=r=>{u.useEffect(()=>{const e=t=>{const{detail:n}=t;r(n)};return window.addEventListener(v,e),()=>{window.removeEventListener(v,e)}},[r])},A=({children:r,node:e})=>{const t=u.useCallback(({word:n,when:s,source:o})=>{o==="local"&&m.database().ref(e).update({[n]:s})},[e]);return I(t),a.jsx(a.Fragment,{children:r})},p=()=>({words:f(W)}),J=({children:r,node:e})=>{const t=f(y),{words:n}=p(),s=u.useCallback(o=>{const d=o.key;if(!d){console.warn("No key specified");return}if(t[d])return;const c=o.val();if(!n.includes(d)){console.warn(`"${d}" is not a recognized word`);return}const l=Date.parse(c);if(l===void 0){console.warn(`"${d}" didn't have a valid date (${c})`);return}window.dispatchEvent(new F(d,new Date(l),"remote"))},[n,t]);return u.useEffect(()=>{const o=m.database().ref(e);return o.on("child_added",s),()=>{o.off("child_added",s)}},[s,e]),a.jsx(a.Fragment,{children:r})},E=r=>{try{const e=localStorage.getItem(r);if(e){const t=JSON.parse(e);if(Array.isArray(t)){localStorage.setItem(`backup/${r}`,e);const n=t.filter(s=>typeof s=="string").reduce((s,o,d)=>({...s,[o]:new Date(d)}),{});return localStorage.setItem(r,JSON.stringify(n)),E(r)}return Object.entries(t).filter(([n,s])=>!!s).reduce((n,[s,o])=>({...n,[s]:o}),{})}}catch{}return{}},P=({children:r})=>{const{path:e}=_();return u.useEffect(()=>{const t={};for(let n=0;n<localStorage.length;n+=1){const s=localStorage.key(n);if(s&&!s.startsWith("backup")){if(s.includes("/saved/")){const o=E(s);if(Object.keys(o).length===0)continue;t[s]=o}s.includes("/revealed/")&&(t[s]=localStorage.getItem(s))}}Object.keys(t).length!==0&&m.database().ref(e).update(t)},[e]),a.jsx(a.Fragment,{children:r})},G=({children:r,node:e})=>{const{words:t}=p();return u.useEffect(()=>{m.database().ref(e).once("value").then(n=>{if(!n.exists())return;const s=t.reduce((c,l)=>({...c,[l]:!0}),{}),o={},d=n.val();Object.entries(d).forEach(([c,l])=>{if(!s[c]){console.warn(`"${c}" is not a recognized word`);return}const i=Date.parse(l);if(i===void 0){console.warn(`"${c}" as an invalid date (${l})`);return}o[c]=new Date(i)}),Object.entries(o).sort(([c,l],[i,g])=>+l-+g).forEach(([c,l])=>{window.dispatchEvent(new F(c,l,"remote"))})})},[e,t]),a.jsx(a.Fragment,{children:r})},U=({children:r})=>{const e=S(),{userId:t}=_();if(!t)return a.jsx(a.Fragment,{children:r});const n=`/users/${t}/${e}`;return a.jsx(P,{node:n,children:a.jsx(A,{node:n,children:a.jsx(G,{node:n,children:a.jsx(J,{node:n,children:a.jsx(a.Fragment,{children:r})})})})})},M=({children:r})=>{const e=S(),t=j(y);u.useEffect(()=>{t(E(e))},[e,t]);const n=u.useCallback(({word:s,when:o})=>{t(d=>{const c={...d,[s]:o};return localStorage.setItem(e,JSON.stringify(c)),c})},[e,t]);return I(n),a.jsx(a.Fragment,{children:r})},T=({children:r})=>{const{error:e}=D(),{error:t}=C();return f(W).length?e?a.jsx("div",{children:"Error loading the letters"}):t?(console.error(t),a.jsx("div",{children:"Error loading the words"})):a.jsx(M,{children:a.jsx(U,{children:r})}):a.jsx(z,{})},B=T,H=()=>{const r=S("revealed"),[e,t]=$(N);return u.useEffect(()=>{const n=localStorage.getItem(r);if(!n){t([]);return}try{const s=JSON.parse(n);if(!Array.isArray(s))return;t(s)}catch(s){console.error(s)}},[r,t]),{reveals:e,revealAnswers:u.useCallback(n=>{t(s=>{const o=[...s,{...n,when:new Date().toISOString()}];return localStorage.setItem(r,JSON.stringify(o)),o})},[r,t])}},q=(r,e)=>e,K=()=>{const r=f(y),{reveals:e}=H(),{words:t}=p(),n=t.filter(s=>!r[s]).filter(s=>e.some(o=>{const d=o.which;switch(d){case"all":return!0;case"letter":return s[0]===o.letter;case"length":return s.length===o.length;case"letter-length":return s[0]===o.letter&&s.length===o.length;default:return q(d,!1)}}));return{found:r,revealedWords:n}},Y=Object.freeze(Object.defineProperty({__proto__:null,default:B,useFoundWords:K,useLetters:L,useWords:p},Symbol.toStringTag,{value:"Module"}));export{F,L as a,p as b,I as c,H as d,Y as i,q as n,K as u};
